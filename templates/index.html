<!DOCTYPE html>
<html>
<head>
    <title>{{ shop.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container">

<nav class="navbar navbar-expand-lg navbar-dark bg-success mb-3">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">{{ shop.name }}</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/add_product">‚ûï Add Product</a>
            <a class="nav-link" href="/drug_master">üìã Drug Master</a>
            <a class="nav-link" href="/invoices">üìÑ Invoices</a>
            <a class="nav-link" href="/expiry_dashboard">‚è∞ Expiry</a>
            <a class="nav-link" href="/logout">Logout</a>
        </div>
    </div>
</nav>

<div class="mb-3 d-flex gap-2">
    <a href="/backup" class="btn btn-outline-primary">üíæ Backup Data</a>

    <form method="post" action="/restore" enctype="multipart/form-data">
        <input type="file" name="backup" accept=".db" required>
        <button class="btn btn-outline-danger">Restore</button>
    </form>
</div>

<h3>Products</h3>

<form method="get" class="mb-3">

    <div class="input-group mb-2">
        <input name="q"
               class="form-control"
               placeholder="Search drug..."
               value="{{ q }}">
        <button class="btn btn-primary">Search</button>
    </div>

    <div class="form-check">
        <input class="form-check-input"
               type="checkbox"
               name="show_expired"
               value="1"
               id="showExpired"
               {% if request.args.get('show_expired') %}checked{% endif %}>
        <label class="form-check-label" for="showExpired">
            Show expired / zero stock batches
        </label>
    </div>

</form>

<table class="table table-striped">
<thead>
<tr>
    <th>Name</th>
    <th>Batch</th>
    <th>Expiry</th>
    <th>Status</th>
    <th>MRP</th>
    <th>Stock</th>
    <th>Adjust</th>
    <th>Qty</th>
    <th>Add</th>
</tr>
</thead>

<tbody>
{% for p in products %}
<tr>
    <td>{{ p.drug_name }}</td>
    <td>{{ p.batch }}</td>
    <td>{{ p.expiry }}</td>

    <td class="{% if expiry_status(p.expiry) == 'EXPIRED' %}text-danger
               {% elif expiry_status(p.expiry) == 'NEAR' %}text-warning
               {% else %}text-success{% endif %}">
        {{ expiry_status(p.expiry) }}
    </td>

    <td>‚Çπ{{ "%.2f"|format(p.mrp) }}</td>

    <td class="{% if p.stock <= p.low_stock_limit %}text-danger fw-bold{% endif %}">
        {{ p.stock }}
        {% if p.stock <= p.low_stock_limit %}
            <div class="small">(Low)</div>
        {% endif %}
    </td>

    <td>
        <a href="/adjust_stock/{{ p.id }}" class="btn btn-sm btn-outline-warning">
            Adjust
        </a>
    </td>

    <!-- ‚úÖ FIXED: VALID FORM HANDLING -->
    <td>
        <input form="f{{ p.id }}"
               name="qty"
               type="number"
               min="1"
               max="{{ p.stock }}"
               value="1"
               class="form-control d-inline"
               style="width:80px;">
    </td>

    <td>
        <form id="f{{ p.id }}" method="post" action="/add_to_cart" class="d-inline">
            <input type="hidden" name="product_id" value="{{ p.id }}">
            <button type="submit" class="btn btn-primary btn-sm">Add</button>
        </form>
    </td>

</tr>
{% endfor %}
</tbody>
</table>

<h3>Cart</h3>

<table class="table table-striped">
<thead>
<tr>
    <th>Item</th>
    <th>Qty</th>
    <th>Total</th>
    <th>Action</th>
</tr>
</thead>

<tbody>
{% for c in cart %}
<tr>
    <td>{{ c.drug_name }}</td>
    <td>{{ c.qty }}</td>
    <td>‚Çπ{{ "%.2f"|format(c.qty * c.mrp) }}</td>
    <td>
        <a href="/remove_from_cart/{{ c.product_id }}" class="btn btn-danger btn-sm">
            Remove
        </a>
    </td>
</tr>
{% endfor %}
</tbody>
</table>

<p class="h4 text-success mb-3">
    Sub Total: ‚Çπ{{ "%.2f"|format(subtotal) }}
</p>

<form method="post" action="/checkout" class="p-3 border rounded">

    <div class="mb-3">
        <input name="customer_name"
               class="form-control form-control-lg"
               placeholder="Customer Name (optional)">
    </div>

    <div class="row g-2 align-items-center">
        <div class="col-5">
            <div class="input-group input-group-lg">
                <span class="input-group-text">Discount %</span>
                <input name="discount" value="0" type="number"
                       min="0" max="100" class="form-control">
            </div>
        </div>

        <div class="col-7">
            <button class="btn btn-success btn-lg w-100">
                Generate Invoice
            </button>
        </div>
    </div>

</form>

</body>
</html>